<meta charset="utf-8"/>
<!--
Show 100 either avlonia's or bevlonia's, with them having to decide which is which.

1) Fetch from server what the category I am learning is, and what the foil category is.
This needs to not be random but chosen so that pairs of subjects see the same categories
as each other but learn a different one (swaps foil and target category). Foil category
is always a different feature.

2) Half of them have to have the target feature and half also have to the foil feature,
with half overlap. So 25 avolnia, 25 bev., 25 both, 25 neither.

3) Break to explain instructions.

4) Again generate 25 of each overlap, this time for the person to study for 3s/item.

5) Then memory test. 80 old items, 20 of each kind. 90 new items: 30 avlonias, 30
bevlonias, 30 of neither.
-->

<style>
.categorizeImage {
  display:none;
}

#question {
  display:none;
}

#instrucBox {
  font-family: Arial, sans-serif;
  font-style: italic;
  margin: 10px auto;
  width:500px;
}

#experimentBox {
  margin: 30px auto;
  margin-top: 10px;
  width:500px;
  height: 500px;
  border: 1px solid gray;
  text-align:center;
}

.textInBox {
  position: relative;
  font-size: 16pt;
  color: #222;
  font-family: Arial, sans-serif;
  top: 200px;
  display: none;
}

.buttonStart {
  font-size: 16pt;
  font-family: Arial, sans-serif;
}

#wrong {
  color: maroon;
}

#correct {
  color: green;
}

#done {
  display: none;
}

#submitButton {
  display: none;
}

#timSubmit {
  font-weight: bold;
  color: black;
  border: 3px outset gray;
  background: #CCC;
  padding: 5px;
  text-decoration: none;
}

#timSubmit:hover {
  border: 3px solid gray;
}

#timSubmit:active {
  border: 3px inset gray;
}

.instrucBox {
  font-family: Arial, sans-serif;
  line-height: 1.4em;
  margin: 30px auto;
  width:500px;
}

#instrucBox {
  display: none;
}
#experimentBox {
  display: none;
}
#learnTestInstruc {
  display: none;
}
#studyInstruc {
  display: none;
}
#testInstruc {
  display: none;
}

#trialCnt {
  float: right;
}

#startExperiment {
  display: none;
}
</style>

<div class="instrucBox" id="categoryInstruc1" style="padding:5px; text-align:left">
<p>This HIT will involve 3 short tasks, all involving pictures of flowers.
  It should take approximately 12-15 minutes to do all 3 tasks.</p>
<p>During the first task, you will see one flower at a time and have to determine whether or not it is an <b>avlonia</b>.
  Avlonias are a particular species of flower.
  They are different from all other flowers in one simple way -- and your job is to find out what that is.
  For example, it could be that avlonias all have 4 petals, but no other flowers do.
  Or avlonias could be the only flowers that have a pink center; or a round petal shape; or a heart in their center.</p>
<p><img src="https://dibs-web01.vm.duke.edu/flower/CategoryLearning/stimuli/flowers/images/stim_6_green_square_purple_2.png" width=245>
  <img src="https://dibs-web01.vm.duke.edu/flower/CategoryLearning/stimuli/flowers/images/stim_4_yellow_circle_orange_1.png" width=245></p>
<p>As you can see from these examples, the flowers in this experiment will differ in a number of ways:
  (1) the number of petals, (2) the color of the petals, (3) the shape of their center,
   (4) the color of their center, and (5) the number of sepals (the black ovals between the petals).
  One of these features will determine what is and is not an avlonia.</p>

<!-- Instruction paragraph for practiced condition -->
<p>
  <span>In the first task, you'll be shown a single flower, and then be <span id='asked'>asked</span> if it is or is not an avlonia</span>
  <span id='keyInstructions'> (press 'y' if yes, 'n' if no)</span>.
  <span id='categoryValue'><b>An avlonia is a flower that has <span id="avloniaDescription"></span>.</b></span>
  <span id='guess'>At first, you'll have to guess. Eventually, though, you'll figure out what makes something an avlonia.</span>
  You will have <span id="numLearning">0</span> flowers to <span id='judge'>judge</span>.
  Do your best to <span id='goal'>determine</span> what makes something an avlonia.
</p><br>

<p><a href="#" class="buttonStart" id="startLearning">I'm Ready to Start Part 1</a>
  <span class="buttonStart" id="loadingLearning">Loading images... Please wait.</span></p><br>
<p><small>By answering the following questions, you are participating in a study
  being performed by psychologists in the Duke Department of Psychology and Neuroscience.
  If you have questions about this research, please contact Felipe De Brigard at felipe.debrigard@duke.edu.
  Your participation in this research is voluntary. You may decline to answer any or all of the following questions.
   You may decline further participation, at any time, without adverse consequences.
   Your anonymity is assured; the researchers who have requested your participation will not
   receive any personal information about you.</small></p>
</div>

<div class="instrucBox" id="learnTestInstruc" style="padding:5px; text-align:left">
<p>Great job!</p>
<p>During the second task, you will be shown a single flower, and then be asked if it is or is not an avlonia. You'll be shown
   <span id="numLearningTest">0</span> flowers, one at a time. This time, you will not be told whether or not the flower was avlonia.
    Do your best to categorize these flowers as well as you can.</p>
<p><a class="buttonStart" href="#" id="startLearningTest">Start next task</a>
  <span class="buttonStart" id="loadingLearningTest">Loading images... Please wait.</span></p>
</div>

<div class="instrucBox" id="studyInstruc" style="padding:5px; text-align:left">
<p>Great job!</p>
<p>During the next task, you will have to remember flowers.
  You'll be shown <span id="numStudy">0</span> flowers, one at a time, for just a few seconds each.
  Do your best to remember these flowers as well as you can.
  If you remember a large number of them successfully, you'll likely get bonus pay.</p>
<p>To help you remember the flowers, we will split up the flowers into
  <span id="numStudyBlocks">0</span> groups of <span id="numStudyBlock">0</span>.
  After seeing each group, you will be asked to recognize the flowers from that group only.</p>
<p>Some of the flowers you have to remember might be avlonias and some might not.</p>
<p><a class="buttonStart" href="#" id="startStudy">Start memory task</a>
  <span class="buttonStart" id="loadingStudy">Loading images... Please wait.</span></p>
</div>

<div class="instrucBox" id="testInstruc" style="padding:5px; text-align:left">
<p>Great job!</p>
<p>During this task, you will have to say which flowers you saw in the previous part and which you didn't.
  You'll be shown <span id="numTest">0</span> flowers, one at a time.
  Some you will have seen before, and some you won't have seen.
   For each flower, you have to say whether you saw it in the last group of flowers you studied.
   If you did see it, press the 'y' key. If you didn't, press the 'n' key. Please do your best!</p>
<p><a class="buttonStart" href="#" id="startTest">Start memory test</a>
  <span class="buttonStart" id="loadingTest">Loading images... Please wait.</span></p>
</div>


<div id="instrucBox"><span id="instrucTextCur">Do you think this is an avlonia? <b>(y/n)</b></span><span id="trialCnt">Trial 1 of 100</span></div>
<div id="experimentBox">
<div id="imagesForLearning"></div>
<div id="imagesForLearningTest"></div>
<div id="imagesForStudy"></div>
<div id="imagesForTest"></div>
<div class="textInBox" id="question">Was this an avlonia?<br><br>y / n</div>
<div class="textInBox" id="correct">Correct</div>
<div class="textInBox" id="wrong">Incorrect</div>

<div class="textInBox" id="done" style="top:60px">Done! You got <span id="numRight">0</span> out of <span id="numTotal">0</span> correct.<br><br>Any comments for us?<br><br>
<textarea name="comments" id="comments" style="width: 300px; height: 200px"></textarea><br><br>
<a href="#" id="timSubmit">Submit</a>
</div>
<div class="textInBox" id="saving">Saving . . .</div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="https://dibs-web01.vm.duke.edu/flower/CategoryLearning/experiments/mturk/TimTurkTools.js"></script>
<script src="https://dibs-web01.vm.duke.edu/flower/CategoryLearning/experiments/mturk/category_learning.js"></script>
<script>
/* Define the values for each feature */
let values = {'numPetal':['4', '6'],
              'petalColor':['blue', 'green'],
              'centerShape':['circle', 'tri'],
              'centerColor':['orange', 'purple'],
              'numSepal':['1', '2']};

let assignmentFilename = 'exp7/experiment7_flower_assignment.json';
let dataDir = 'exp7/data';

/* Get filename for an object */
function GetFlowerFilename(obj) {
  return ("https://dibs-web01.vm.duke.edu/flower/CategoryLearning/stimuli/flowers/images/stim_"
    + obj.numPetal + "_" + obj.petalColor + "_"
    + obj.centerShape + "_" + obj.centerColor
    + "_" + obj.numSepal + ".png");
}

/* Parameters for stimuli */
let nLearning = 1;
let pLearnedLearning = 1/3.0;
let pFoilLearning = 1/3.0;

let nLearningTest = 1;
let pLearnedLearningTest = 1/3.0;
let pFoilLearningTest = 1/3.0;

let nStudy = 9;
let pLearnedStudy = 1/3.0;
let pFoilStudy = 1/3.0;

let nTest = 18;
let nTestBlocks = 3;
let pLearnedTest = 1/3.0;  // p for lures, not old items
let pFoilTest = 1/3.0;

/* Parameters for learning conditions */
let conditions = ['practiced', 'instructed', 'instructed+practiced', 'neither'];
let condition = -1;
let practiced = -1;
let instructed = -1;


function nextAssignment(oldAssignment, values) {
  let newAssignment = nextAssignmentDefault(oldAssignment, values);

  // try incrementing the learning condition
  if (newAssignment.featureLearned == 0 && newAssignment.valueLearned == 0) {
    newAssignment.learningCondition = newAssignment.learningCondition + 1;

    // if we reached the last condition then reset to 0
    if (newAssignment.learningCondition >= conditions.length) {
      newAssignment.learningCondition = 0;
    }
  }

  return newAssignment;
}


function StartPassiveLearning(itemsForLearning) {
  if (IsOnTurk() && IsTurkPreview()) {
    alert('Please accept the HIT before beginning!');
    return;
  }
  $('#categoryInstruc1').hide();
  $('#instrucTextCur').html('Is this is an avlonia?');
  $('#instrucBox').show();
  $('#experimentBox').show();
  NextTrialPassiveLearning(0, itemsForLearning);
}

function NextTrialPassiveLearning(curTrial, itemsForLearning) {
  // set the correct/incorrect text to yes/no
  $('#correct').text('Yes');
  $('#wrong').text('No');

  $('#trialCnt').text("Trial " + (curTrial+1) + " of " + itemsForLearning.length);
  $('#' + itemsForLearning[curTrial].id).show();
  let startTrialTime = (new Date()).getTime();

  // show the flower for 5 seconds
  setTimeout(function () {
    let curTrialItem = itemsForLearning[curTrial];
    $('#' + curTrialItem.id).hide();
    curTrialItem['wasCorrect'] = -1;  // set to -1 since no response is recorded
    curTrialItem['RT'] = (new Date()).getTime() - startTrialTime;

    if (curTrialItem['isTarget']) {
      $('#correct').show();
    } else {
      $('#wrong').show();
    }

    setTimeout(function() {
     $('#correct').hide();
     $('#wrong').hide();

     if (curTrial<itemsForLearning.length-1) {
       NextTrialPassiveLearning(curTrial+1, itemsForLearning);
     } else {
       ShowLearningTestStart();
     }
   }, 1000);
 }, 3000);
}

function categoryDescription(feature, value) {
  let featureDescr = {'numPetal':'petals',
                      'petalColor':'petals',
                      'centerShape':'center',
                      'centerColor':'center',
                      'numSepal':'sepals'};
  let valueDescr = {'4':'four', '6':'six', '8':'eight',
                    'blue':'blue', 'green':'green', 'yellow':'yellow',
                    'circle':'circular', 'tri':'triangular', 'square':'square',
                    'brightgreen':'green', 'orange':'orange', 'purple':'purple',
                    '1':'one', '2':'two', '3':'three'};

  return ((featureDescr[feature] === 'center')? 'a ' : '')
          + valueDescr[value] + ' '
          + ((featureDescr[feature] === 'sepals' && value === '1')? 'sepal' : featureDescr[feature]);
}

async function SaveExpData(experimentName, dataDir, progressDir, featureLearned, valueLearned,
                        featureFoil, valueFoil, itemsForLearning,
                        itemsForLearningTest, itemsForStudy, itemsForTest) {
  $('#done').hide();
  $('#saving').show();

  let correctRate = parseFloat($('#numRight').text(), 10) / itemsForTest.length;
  let earnedBonus = correctRate >= 0.85;
  let curID = GetID();

  Save("isPracticed", practiced);
  Save("isInstructed", instructed);
  Save("correctRate", correctRate);
  Save("earnedBonus", earnedBonus);
  Save("featuredLearned", featureLearned);
  Save("featureFoil", featureFoil);
  Save("valueLearned", valueLearned);
  Save("valueFoil", valueFoil);

  for (let i=0; i<itemsForLearning.length; i++) {
    Save(itemsForLearning[i].id, itemsForLearning[i]);
  }
  for (let i=0; i<itemsForLearningTest.length; i++) {
    Save(itemsForLearningTest[i].id, itemsForLearning[i]);
  }
  for (let i=0; i<itemsForStudy.length; i++) {
    Save(itemsForStudy[i].id, itemsForStudy[i]);
  }
  for (let i=0; i<itemsForTest.length; i++) {
    Save(itemsForTest[i].id, itemsForTest[i]);
  }
  Save("userAgent", navigator.userAgent);
  Save("windowWidth", $(window).width());
  Save("windowHeight", $(window).height());
  Save("screenWidth", screen.width);
  Save("screenHeight", screen.height);

  let newDate = new Date();
  let d = {
    "curID": curID,
    "curTime": newDate.today() + " @ " + newDate.timeNow(),
    "userAgent": navigator.userAgent,
    "windowWidth": $(window).width(),
    "windowHeight": $(window).height(),
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "comments": $('#comments').val(),
    "isPracticed": practiced,
    "isInstructed": instructed,
    "correctRate": correctRate,
    "earnedBonus": earnedBonus,
    "featureLearned": featureLearned,
    "featureFoil": featureFoil,
    "valueLearned": valueLearned,
    "valueFoil": valueFoil,
    "itemsForLearning": itemsForLearning,
    "itemsForLearningTest": itemsForLearningTest,
    "itemsForStudy": itemsForStudy,
    "itemsForTest": itemsForTest
  };

  return SendToServer(curID, d, experimentName, dataDir);
}


/* On page load */
$(function () {
    $('#categoryValue').hide();

    fetchJSON(assignmentFilename).then(function (data) {
      condition = conditions[data.learningCondition];
      practiced = condition.includes('practiced');
      instructed = condition.includes('instructed');

      let learningFn = null;  // if the learning is active, use the default learning fn
      if (!practiced) {
        learningFn = StartPassiveLearning;
        $('#asked').text('told');
        $('#keyInstructions').hide();
        $('#judge').text('view');
      }

      console.log(condition);
      if (IsOnTurk() && IsTurkPreview()) {
        $('#numLearning').text(nLearning);
        $('#numStudy').text(nStudy);
        $('#numTest').text(nTest);
        $('#startLearning').hide();
        return;
      }

      StartExperiment('flower_E7', assignmentFilename, GetFlowerFilename, values,
                      nLearning, pLearnedLearning, pFoilLearning,
                      nLearningTest, pLearnedLearningTest, pFoilLearningTest,
                      nStudy, pLearnedStudy, pFoilStudy,
                      nTest, pLearnedTest, pFoilTest, nTestBlocks, dataDir, null,
                      learningFn, null, null, null, SaveExpData, nextAssignment)
                      .then(function (expData) {
                        if (instructed) {
                          $('#avloniaDescription').text(categoryDescription(expData['featureLearned'], expData['valueLearned']));
                          $('#categoryValue').show();
                          $('#guess').hide();
                          $('#goal').text('remember');
                        }

                        // After 90s show the link to continue
                        setTimeout(function () {
                            $('#loadingLearning').hide();
                            $('#startLearning').show();
                        }, waitTime);
                      });

    });
  });

</script>
